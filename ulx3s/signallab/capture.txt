
\ ------------------------------------------------------------------------------
\   Registers
\ ------------------------------------------------------------------------------

$2030 constant adc-result
$2040 constant adc-channel
$20B0 constant adc-valid
$20C0 constant adc-fifo

\ ------------------------------------------------------------------------------
\   Capture using FIFOs in logic
\ ------------------------------------------------------------------------------

: capture ( -- )

  \ Clear FIFO
  begin
    adc-valid io@
  while
    adc-fifo io@ drop
  repeat

  \ Capture measurements
  fft-real
  begin
    begin adc-valid io@ until adc-fifo io@

    over !
    1 cells +
    dup fft-real N_WAVE cells + =
  until
  drop

  fft-imag N_WAVE cells 0 fill
;

\ ------------------------------------------------------------------------------
\   Analyse the signal
\ ------------------------------------------------------------------------------

: show ( -- )

  signalplot-lin-min-max
  printstats
  signal-binning

  \ un<->signed

  LOG2_N_WAVE false fix-fft drop
  LOG2_N_WAVE fftswap

  250,000 samplerate 2!
  fft-plot
;

\ How to use:
\
\   0 adc-channel io!
\   capture show
